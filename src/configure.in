dnl Process this file with autoconf to produce a configure script.

# Configuration script for the MCell software.
#             [--with-security=labname]
#             [--with-debug=[yes|no]]
#             [--with-crosscompile=arch]
#             [--with-mp=[yes|no]]
#

AC_INIT(makedefs.in)

dnl Checks for programs.
AC_PROG_YACC
AC_PROG_LEX
AC_PROG_MAKE_SET

dnl Checks for typedefs, structures, and compiler characteristics.
dnl *** Compiler and linker switches.
AC_PROG_CC
AC_C_CONST
AC_TYPE_SIZE_T
AC_STRUCT_TM
LD=$CC
if test "${CC}" = "gcc"; then
  CFLAGS="-O2"
else
  CFLAGS=""
fi

INSTALL_DIR="$HOME/bin"
MCELL_EXEC="mcell"
L_CALC_EXEC="l_calc"
LIBS="${LIBS} -lm"

dnl Checks for header files.
AC_HEADER_STDC
AC_CHECK_HEADERS(fcntl.h limits.h malloc.h sys/time.h unistd.h)

dnl Checks for library functions.
AC_CHECK_FUNCS(gethostname strcspn)

AC_MSG_CHECKING(system executable paths)

dnl find out the target platform
ARCH_TYPE="`./arch_type`"

dnl *** crosscompile
AC_ARG_WITH(crosscompile,
            [ --with-crosscompile      Cross-compile for arch (linux...)],
	    [CROSS_COMPILE="${withval}"],
	    [CROSS_COMPILE=""])
if test -n "$CROSS_COMPILE"; then
  CC="/compat/linux/usr/bin/gcc"
  ARCH_TYPE=$CROSS_COMPILE
fi

# Ugly arch specific things
case "$ARCH_TYPE" in
  linux | freebsd )
    CFLAGS="${CFLAGS} -m486 -fomit-frame-pointer";;
  alpha )
    CFLAGS="-non_shared -migrate -O5 -g0 -tune host -std1 -inline speed -ifo -D_FASTMATH -D_INLINE_INTRINSICS";;
  sgi )
    CC="cc"
    CFLAGS="-n32 -mips4 -r10000";;
  sparc | rs6000 )
    ;;
esac

dnl *** security
AC_ARG_WITH(security,
            [ --with-security          Compile MCell w or w/o security (labname) ],
	    [SECURITY="${withval}"],
	    [SECURITY=""])

if test -z "$SECURITY"; then
  CFLAGS="${CFLAGS} -DSECURITY_OFF "; 
else
  CFLAGS="${CFLAGS} -DLICENSE_CODES_FROM_FILE "
  ./create_license_codes.pl ${SECURITY} ${ARCH_TYPE};
fi

dnl *** debug
AC_ARG_WITH(debug,
            [ --with-debug             Debugging mode],
	    [DEBUG="${withval}"],
	    [DEBUG=""])
if test -n "$DEBUG"; then
  CFLAGS="${CFLAGS} -DDEBUG -g";
fi

dnl *** mp
# run with 'mpirun -machinefile ~/.machfile -np 2 ~/src/mcell/pmcell nmj_norm'
AC_ARG_WITH(mp,
            [ --with-mp                Parallel version with KeLP and MPI],
	    [MP="${withval}"],
	    [MP="none"])
case "$MP" in
  yes)
    AC_PROG_CXX
    CC="g++"
    CFLAGS="${CFLAGS} -DKELP -I $KELP_HOME/include -I /usr/local/mpich/include"
    LD="mpiCC"
    LIBS="${LIBS} -L$KELP_HOME/lib -ldgrid -ldock -lkelp -ltools -larray -lmp++  -lGrid"
	MCELL_EXEC="pmcell";;
  no)
    ;;
esac

AC_SUBST(CC)
AC_SUBST(CFLAGS)
AC_SUBST(LIBS)
AC_SUBST(LD)
AC_SUBST(INSTALL_DIR)
AC_SUBST(MCELL_EXEC)
AC_SUBST(L_CALC_EXEC)
AC_SUBST(EXTRAS)


AC_OUTPUT(makedefs)
